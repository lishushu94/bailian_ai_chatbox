<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å­—æœºæ•ˆæœä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            min-height: 100vh;
            margin: 0;
        }
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .message {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            min-height: 40px;
            position: relative;
            border-left: 4px solid #6c5ce7;
        }
        .streaming-content {
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
            backface-visibility: hidden;
            transform: translateZ(0);
            will-change: contents;
        }
        .streaming-content::after {
            content: '|';
            animation: cursor-blink 1.2s infinite;
            color: #6c5ce7;
            font-weight: bold;
            margin-left: 2px;
            opacity: 1;
        }
        @keyframes cursor-blink {
            0%, 40% { opacity: 1; }
            50%, 90% { opacity: 0; }
            100% { opacity: 1; }
        }
        button {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #574b90;
            transform: translateY(-2px);
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            color: #2d5016;
            border-left: 4px solid #4caf50;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        h1 {
            color: #2d3436;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #636e72;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        #messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ› ï¸ æ‰“å­—æœºæ•ˆæœä¿®å¤æµ‹è¯•</h1>
        <p class="subtitle">éªŒè¯ä¿®å¤åçš„æ‰“å­—æœºæ•ˆæœæ˜¯å¦å½»åº•è§£å†³é—ªçƒé—®é¢˜</p>
        
        <div class="status" id="status">âœ… å‡†å¤‡å°±ç»ª - ä¿®å¤ç‰ˆæœ¬å·²åŠ è½½</div>
        
        <div class="test-section">
            <h3>ğŸ” æ ¸å¿ƒé—®é¢˜æµ‹è¯•</h3>
            <button onclick="testOriginalProblem()">æµ‹è¯•åŸå§‹é—®é¢˜ï¼ˆé¢‘ç¹é—ªçƒï¼‰</button>
            <button onclick="testFixedVersion()">æµ‹è¯•ä¿®å¤ç‰ˆæœ¬ï¼ˆå¹³æ»‘æ˜¾ç¤ºï¼‰</button>
            <button onclick="testRapidUpdates()">æµ‹è¯•å¿«é€Ÿæ›´æ–°åœºæ™¯</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ€§èƒ½æµ‹è¯•</h3>
            <button onclick="testManyMessages()">æµ‹è¯•å¤šæ¡æ¶ˆæ¯</button>
            <button onclick="testLargeContent()">æµ‹è¯•å¤§æ–‡æœ¬å†…å®¹</button>
            <button onclick="testContinuousStreaming()">æµ‹è¯•è¿ç»­æµå¼ä¼ è¾“</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§¹ æ¸…ç†</h3>
            <button onclick="clearMessages()">æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯</button>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        // åŸå§‹çš„æœ‰é—®é¢˜çš„æ‰“å­—æœºæ•ˆæœï¼ˆç”¨äºå¯¹æ¯”ï¼‰
        function originalTypeWriterEffect(element, text, speed = 30) {
            // è¿™æ˜¯åŸå§‹çš„æœ‰é—®é¢˜çš„å®ç°
            let i = 0;
            element.innerHTML = ''; // é—®é¢˜ï¼šæ¯æ¬¡éƒ½é‡ç½®å†…å®¹
            
            function type() {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1);
                    i++;
                    setTimeout(type, speed);
                }
            }
            
            type();
        }

        // ä¿®å¤åçš„æ‰“å­—æœºæ•ˆæœ
        function fixedTypeWriterEffect(element, text, speed = 30) {
            // å¦‚æœæ–‡æœ¬æ²¡æœ‰å˜åŒ–ï¼Œä¸è¿›è¡Œå¤„ç†
            if (element.innerHTML === text) {
                return;
            }
            
            // ç›´æ¥è®¾ç½®å®Œæ•´å†…å®¹ï¼Œä¸å†é€å­—ç¬¦æ˜¾ç¤º
            element.innerHTML = text;
        }

        function createMessage(text, useOriginal = false, title = '') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            if (title) {
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = 'font-size: 12px; color: #6c757d; margin-bottom: 5px; font-weight: bold;';
                titleDiv.textContent = title;
                messageDiv.appendChild(titleDiv);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'streaming-content';
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            if (useOriginal) {
                originalTypeWriterEffect(contentDiv, text, 50);
            } else {
                fixedTypeWriterEffect(contentDiv, text, 50);
            }
            
            return contentDiv;
        }

        function testOriginalProblem() {
            updateStatus('æµ‹è¯•åŸå§‹é—®é¢˜å®ç°...', 'warning');
            
            const text = "è¿™æ˜¯åŸå§‹çš„æœ‰é—®é¢˜çš„æ‰“å­—æœºæ•ˆæœã€‚\næ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡ç½®å†…å®¹ï¼Œå¯¼è‡´é—ªçƒã€‚\n\nè§‚å¯Ÿï¼šå†…å®¹ä¼šé‡æ–°å¼€å§‹æ˜¾ç¤º";
            createMessage(text, true, 'âŒ åŸå§‹å®ç°ï¼ˆä¼šé—ªçƒï¼‰');
            
            // æ¨¡æ‹Ÿå¤šæ¬¡å¿«é€Ÿè°ƒç”¨ï¼Œå±•ç¤ºé—®é¢˜
            setTimeout(() => {
                const contentDiv = document.querySelector('#messages .message:last-child .streaming-content');
                const newText = text + "\n\nè¿™æ˜¯è¿½åŠ çš„å†…å®¹ï¼Œä¼šé‡æ–°å¼€å§‹æ˜¾ç¤º";
                originalTypeWriterEffect(contentDiv, newText, 50);
            }, 2000);
        }

        function testFixedVersion() {
            updateStatus('æµ‹è¯•ä¿®å¤åçš„ç‰ˆæœ¬...', 'status');
            
            const text = "è¿™æ˜¯ä¿®å¤åçš„æ‰“å­—æœºæ•ˆæœã€‚\nç›´æ¥è®¾ç½®å®Œæ•´å†…å®¹ï¼Œä¸å†é€å­—ç¬¦æ˜¾ç¤ºã€‚\n\nè§‚å¯Ÿï¼šå†…å®¹å¹³æ»‘æ›´æ–°ï¼Œæ— é—ªçƒ";
            createMessage(text, false, 'âœ… ä¿®å¤ç‰ˆæœ¬ï¼ˆæ— é—ªçƒï¼‰');
            
            // æ¨¡æ‹Ÿå†…å®¹æ›´æ–°ï¼Œå±•ç¤ºä¿®å¤æ•ˆæœ
            setTimeout(() => {
                const contentDiv = document.querySelector('#messages .message:last-child .streaming-content');
                const newText = text + "\n\nè¿™æ˜¯è¿½åŠ çš„å†…å®¹ï¼Œå¹³æ»‘æ›´æ–°";
                fixedTypeWriterEffect(contentDiv, newText);
            }, 2000);
        }

        function testRapidUpdates() {
            updateStatus('æµ‹è¯•å¿«é€Ÿæ›´æ–°åœºæ™¯...', 'status');
            
            const contentDiv = createMessage('', false, 'ğŸš€ å¿«é€Ÿæ›´æ–°æµ‹è¯•');
            
            let text = '';
            const words = ['å¿«é€Ÿ', 'æ›´æ–°', 'æµ‹è¯•', 'ã€‚', '\n', 'å†…å®¹', 'åº”è¯¥', 'å¹³æ»‘', 'æ˜¾ç¤º', 'ï¼Œ', 'æ²¡æœ‰', 'é—ªçƒ', 'ã€‚'];
            let wordIndex = 0;
            
            function addNextWord() {
                if (wordIndex < words.length) {
                    text += words[wordIndex];
                    wordIndex++;
                    
                    // ä½¿ç”¨ä¿®å¤åçš„ç‰ˆæœ¬å¿«é€Ÿæ›´æ–°
                    fixedTypeWriterEffect(contentDiv, text);
                    
                    setTimeout(addNextWord, 100); // å¿«é€Ÿæ›´æ–°
                } else {
                    updateStatus('å¿«é€Ÿæ›´æ–°æµ‹è¯•å®Œæˆ - åº”è¯¥æ— é—ªçƒ', 'status');
                }
            }
            
            addNextWord();
        }

        function testManyMessages() {
            updateStatus('æµ‹è¯•å¤šæ¡æ¶ˆæ¯åœºæ™¯...', 'status');
            
            const messages = [
                "ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼šåº”è¯¥å¹³æ»‘æ˜¾ç¤º",
                "ç¬¬äºŒæ¡æ¶ˆæ¯ï¼šå¿«é€Ÿæ˜¾ç¤ºï¼Œæ— é—ªçƒ",
                "ç¬¬ä¸‰æ¡æ¶ˆæ¯ï¼šæ€§èƒ½è‰¯å¥½",
                "ç¬¬å››æ¡æ¶ˆæ¯ï¼šè¿ç»­æ›´æ–°æµ‹è¯•",
                "ç¬¬äº”æ¡æ¶ˆæ¯ï¼šæœ€ç»ˆéªŒè¯"
            ];
            
            messages.forEach((msg, index) => {
                setTimeout(() => {
                    createMessage(msg, false, `ğŸ“¨ æ¶ˆæ¯ ${index + 1}`);
                }, index * 500);
            });
            
            setTimeout(() => {
                updateStatus('å¤šæ¡æ¶ˆæ¯æµ‹è¯•å®Œæˆ', 'status');
            }, messages.length * 500 + 1000);
        }

        function testLargeContent() {
            updateStatus('æµ‹è¯•å¤§æ–‡æœ¬å†…å®¹...', 'status');
            
            const largeText = `è¿™æ˜¯ä¸€ä¸ªå¤§æ–‡æœ¬å†…å®¹æµ‹è¯•ã€‚

ç›®çš„ï¼šéªŒè¯ä¿®å¤åçš„æ‰“å­—æœºæ•ˆæœåœ¨å¤„ç†å¤§é‡æ–‡æœ¬æ—¶çš„æ€§èƒ½ã€‚

${Array(10).fill(0).map((_, i) => 
    `ç¬¬${i + 1}æ®µï¼šè¿™æ˜¯ç¬¬${i + 1}æ®µæµ‹è¯•æ–‡æœ¬ã€‚åœ¨å¤„ç†å¤§æ–‡æœ¬æ—¶ï¼Œä¿®å¤åçš„ç‰ˆæœ¬åº”è¯¥è¡¨ç°å‡ºè‰¯å¥½çš„æ€§èƒ½ï¼Œä¸ä¼šå‡ºç°å¡é¡¿æˆ–é—ªçƒé—®é¢˜ã€‚åŸå§‹ç‰ˆæœ¬ä¼šå› ä¸ºé¢‘ç¹çš„DOMæ“ä½œè€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚`
).join('\n\n')}

æµ‹è¯•å®Œæˆï¼šå¤§æ–‡æœ¬åº”è¯¥å¿«é€Ÿæ˜¾ç¤ºï¼Œæ— æ€§èƒ½é—®é¢˜ã€‚`;
            
            createMessage(largeText, false, 'ğŸ“„ å¤§æ–‡æœ¬æµ‹è¯•');
            
            setTimeout(() => {
                updateStatus('å¤§æ–‡æœ¬æµ‹è¯•å®Œæˆ - æ€§èƒ½è‰¯å¥½', 'status');
            }, 1000);
        }

        function testContinuousStreaming() {
            updateStatus('æµ‹è¯•è¿ç»­æµå¼ä¼ è¾“...', 'status');
            
            const contentDiv = createMessage('', false, 'ğŸŒŠ æµå¼ä¼ è¾“æ¨¡æ‹Ÿ');
            
            let text = '';
            const sentences = [
                "è¿™æ˜¯æ¨¡æ‹Ÿçš„æµå¼å“åº”ã€‚",
                "å†…å®¹åº”è¯¥é€æ¸å‡ºç°ã€‚",
                "å°±åƒAIåœ¨å®æ—¶è¾“å…¥ä¸€æ ·ã€‚",
                "æ¯å¥è¯éƒ½ä¼šå¹³æ»‘åœ°è¿½åŠ ã€‚",
                "æ²¡æœ‰é—ªçƒæˆ–é‡ç½®é—®é¢˜ã€‚",
                "ä¿®å¤åçš„ç‰ˆæœ¬è¡¨ç°è‰¯å¥½ã€‚"
            ];
            
            let sentenceIndex = 0;
            
            function addNextSentence() {
                if (sentenceIndex < sentences.length) {
                    text += (sentenceIndex > 0 ? ' ' : '') + sentences[sentenceIndex];
                    sentenceIndex++;
                    
                    // æ¨¡æ‹Ÿæµå¼æ›´æ–°
                    fixedTypeWriterEffect(contentDiv, text);
                    
                    setTimeout(addNextSentence, 800);
                } else {
                    updateStatus('æµå¼ä¼ è¾“æµ‹è¯•å®Œæˆ', 'status');
                }
            }
            
            addNextSentence();
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            updateStatus('âœ… æ¶ˆæ¯å·²æ¸…ç©º', 'status');
        }

        function updateStatus(message, type = 'status') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.textContent = message;
        }

        function runAllTests() {
            updateStatus('ğŸ”„ æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'status');
            
            const tests = [
                testFixedVersion,
                () => setTimeout(testRapidUpdates, 3000),
                () => setTimeout(testManyMessages, 6000),
                () => setTimeout(testLargeContent, 10000),
                () => setTimeout(testContinuousStreaming, 13000)
            ];
            
            tests.forEach((test, index) => {
                setTimeout(test, index * 3000);
            });
            
            setTimeout(() => {
                updateStatus('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ - ä¿®å¤ç‰ˆæœ¬è¡¨ç°è‰¯å¥½', 'status');
            }, tests.length * 3000 + 3000);
        }
    </script>
</body>
</html>